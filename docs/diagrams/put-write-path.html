<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confman — PUT Write Path</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&display=swap');

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0c0e14;
    --surface: #181c28;
    --border: rgba(255,255,255,0.06);
    --text: #e8eaf0;
    --text-dim: #6b7394;
    --text-muted: #3d4463;
    --client: #8b5cf6;
    --decision: #f472b6;
    --inline: #34d399;
    --blob: #38bdf8;
    --raft: #fbbf24;
    --apply: #a78bfa;
    --redirect: #fb7185;
    --font: 'DM Sans', system-ui, -apple-system, sans-serif;
    --mono: 'JetBrains Mono', 'SF Mono', monospace;
  }

  html, body {
    width: 100%; height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    overflow-x: hidden;
  }

  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 60px 20px 80px;
    background:
      radial-gradient(ellipse 80% 50% at 50% 0%, rgba(139,92,246,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 50% 30% at 15% 70%, rgba(56,189,248,0.04) 0%, transparent 50%),
      radial-gradient(ellipse 50% 30% at 85% 55%, rgba(251,191,36,0.03) 0%, transparent 50%),
      var(--bg);
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,255,255,0.012) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.012) 1px, transparent 1px);
    background-size: 80px 80px;
    pointer-events: none;
    z-index: 0;
  }

  .header {
    text-align: center;
    margin-bottom: 70px;
    position: relative;
    z-index: 1;
  }

  .header h1 {
    font-size: 12px; font-weight: 500;
    letter-spacing: 5px; text-transform: uppercase;
    color: var(--text-muted); margin-bottom: 16px;
  }

  .header h2 {
    font-size: 46px; font-weight: 700; letter-spacing: -1.5px;
    background: linear-gradient(135deg, #e8eaf0 0%, #8b9dc3 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }

  .header .subtitle {
    font-size: 15px; color: var(--text-dim); margin-top: 12px; font-weight: 400;
  }

  .header .subtitle code {
    font-family: var(--mono); font-size: 13px; color: var(--client);
    background: rgba(139,92,246,0.1); padding: 2px 8px; border-radius: 4px;
  }

  /* Flow layout — no absolute positioning! */
  .flow {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
    position: relative;
    z-index: 1;
    width: 1300px;
    max-width: 100%;
  }

  .flow-row {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    width: 100%;
    position: relative;
  }

  .flow-spacer {
    height: 60px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .flow-spacer-lg { height: 80px; }

  /* Vertical connector line */
  .vline {
    width: 2px;
    height: 100%;
    position: absolute;
    left: 50%;
    top: 0;
    transform: translateX(-50%);
  }

  .vline::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 0; height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
  }

  .vline.main {
    background: rgba(255,255,255,0.1);
  }
  .vline.main::after { border-top: 6px solid rgba(255,255,255,0.2); }

  .vline.gold {
    background: rgba(251,191,36,0.25);
  }
  .vline.gold::after { border-top: 6px solid rgba(251,191,36,0.4); }

  /* Fork row with branches */
  .fork-row {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    width: 100%;
    gap: 80px;
  }

  .branch {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
  }

  .branch-label {
    font-family: var(--mono);
    font-size: 10px; font-weight: 500;
    letter-spacing: 2px; text-transform: uppercase;
    padding: 5px 14px; border-radius: 20px;
    margin-bottom: 20px;
  }

  .branch-label.inline-label {
    color: var(--inline);
    background: rgba(52,211,153,0.06);
    border: 1px solid rgba(52,211,153,0.12);
  }

  .branch-label.blob-label {
    color: var(--blob);
    background: rgba(56,189,248,0.06);
    border: 1px solid rgba(56,189,248,0.12);
  }

  .branch-spacer {
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    width: 2px;
  }

  .branch-spacer .vline {
    width: 2px;
    height: 100%;
    position: absolute;
    left: 0;
    top: 0;
  }

  .branch-spacer .vline.blue {
    background: rgba(56,189,248,0.25);
  }
  .branch-spacer .vline.blue::after { border-top: 6px solid rgba(56,189,248,0.4); }

  .branch-spacer .vline.green {
    background: rgba(52,211,153,0.25);
  }
  .branch-spacer .vline.green::after { border-top: 6px solid rgba(52,211,153,0.4); }

  /* Convergence label */
  .converge-label {
    font-family: var(--mono);
    font-size: 9px; letter-spacing: 2px;
    text-transform: uppercase; color: var(--text-muted);
    margin-bottom: 8px;
  }

  /* Side redirect */
  .leader-row {
    display: flex;
    align-items: center;
    gap: 60px;
  }

  .redirect-arrow {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .redirect-arrow .line {
    width: 50px; height: 2px;
    background: rgba(251,113,133,0.25);
    position: relative;
  }

  .redirect-arrow .line::before {
    content: '';
    position: absolute;
    left: -5px; top: 50%; transform: translateY(-50%);
    width: 0; height: 0;
    border-right: 6px solid rgba(251,113,133,0.35);
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
  }

  .redirect-arrow .dash-text {
    font-family: var(--mono); font-size: 9px;
    letter-spacing: 1px; color: var(--text-muted);
    white-space: nowrap;
  }

  /* Cards — 3D slab effect */
  .iso-card {
    --depth-color: rgba(255,255,255,0.03);
    --depth-size: 8px;
    position: relative;
    padding: 20px 24px;
    border-radius: 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.4s ease;
    animation: nodeIn 0.7s cubic-bezier(0.16, 1, 0.3, 1) both;
    z-index: 1;
  }

  /* Bottom depth edge */
  .iso-card::before {
    content: '';
    position: absolute;
    left: 4px;
    right: -2px;
    bottom: calc(-1 * var(--depth-size));
    height: var(--depth-size);
    background: var(--depth-color);
    border-radius: 0 0 14px 14px;
    z-index: -1;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
  }

  /* Right depth edge */
  .iso-card::after {
    content: '';
    position: absolute;
    top: 4px;
    bottom: -2px;
    right: calc(-1 * var(--depth-size));
    width: var(--depth-size);
    background: var(--depth-color);
    border-radius: 0 14px 14px 0;
    z-index: -1;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
  }

  @keyframes nodeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .iso-card:hover {
    transform: translate(-2px, -4px);
  }
  .iso-card:hover::before {
    transform: translateY(2px);
  }
  .iso-card:hover::after {
    transform: translateX(2px);
  }

  .iso-card .step-num {
    font-family: var(--mono); font-size: 10px; font-weight: 500;
    letter-spacing: 2.5px; text-transform: uppercase;
    margin-bottom: 8px; opacity: 0.45;
  }

  .iso-card .title {
    font-size: 16px; font-weight: 600; letter-spacing: -0.3px; margin-bottom: 6px;
  }

  .iso-card .desc {
    font-size: 12.5px; color: var(--text-dim); line-height: 1.6;
  }

  .iso-card .desc code {
    font-family: var(--mono); font-size: 10.5px;
    background: rgba(255,255,255,0.05); padding: 1px 5px; border-radius: 3px;
  }

  /* Card variants */
  .iso-card.client {
    --depth-color: rgba(139,92,246,0.2);
    background: linear-gradient(135deg, rgba(139,92,246,0.14) 0%, rgba(139,92,246,0.04) 100%);
    border-color: rgba(139,92,246,0.22);
    box-shadow: 0 10px 40px rgba(139,92,246,0.1), 0 0 0 1px rgba(139,92,246,0.06);
    width: 260px; text-align: center;
  }
  .iso-card.client .title { color: var(--client); }

  .iso-card.decision {
    --depth-color: rgba(244,114,182,0.18);
    background: linear-gradient(135deg, rgba(244,114,182,0.08) 0%, rgba(244,114,182,0.02) 100%);
    border-color: rgba(244,114,182,0.18);
    box-shadow: 0 10px 36px rgba(244,114,182,0.06);
    text-align: center; width: 280px;
  }
  .iso-card.decision .title { color: var(--decision); }

  .iso-card.redirect {
    --depth-color: rgba(251,113,133,0.18);
    background: linear-gradient(135deg, rgba(251,113,133,0.08) 0%, rgba(251,113,133,0.02) 100%);
    border-color: rgba(251,113,133,0.18);
    box-shadow: 0 8px 28px rgba(251,113,133,0.06);
    width: 160px;
  }
  .iso-card.redirect .title { color: var(--redirect); font-size: 14px; }

  .iso-card.inline {
    --depth-color: rgba(52,211,153,0.2);
    background: linear-gradient(135deg, rgba(52,211,153,0.1) 0%, rgba(52,211,153,0.02) 100%);
    border-color: rgba(52,211,153,0.18);
    box-shadow: 0 10px 36px rgba(52,211,153,0.08);
    width: 280px;
  }
  .iso-card.inline .title { color: var(--inline); }

  .iso-card.blob {
    --depth-color: rgba(56,189,248,0.22);
    background: linear-gradient(135deg, rgba(56,189,248,0.1) 0%, rgba(56,189,248,0.02) 100%);
    border-color: rgba(56,189,248,0.18);
    box-shadow: 0 10px 36px rgba(56,189,248,0.08);
    width: 300px;
  }
  .iso-card.blob .title { color: var(--blob); }
  .iso-card.blob:hover { box-shadow: 0 16px 48px rgba(56,189,248,0.15); }

  .iso-card.raft {
    --depth-color: rgba(251,191,36,0.28);
    --depth-size: 10px;
    background: linear-gradient(135deg, rgba(251,191,36,0.12) 0%, rgba(251,191,36,0.03) 100%);
    border-color: rgba(251,191,36,0.25);
    box-shadow: 0 12px 48px rgba(251,191,36,0.12), 0 0 0 1px rgba(251,191,36,0.08);
    text-align: center; width: 380px;
  }
  .iso-card.raft .title { color: var(--raft); font-size: 18px; }
  .iso-card.raft:hover { box-shadow: 0 18px 60px rgba(251,191,36,0.2); }

  .iso-card.apply {
    --depth-color: rgba(167,139,250,0.2);
    background: linear-gradient(135deg, rgba(167,139,250,0.1) 0%, rgba(167,139,250,0.02) 100%);
    border-color: rgba(167,139,250,0.18);
    box-shadow: 0 10px 36px rgba(167,139,250,0.08);
    text-align: center; width: 340px;
  }
  .iso-card.apply .title { color: var(--apply); }

  .iso-card.ok {
    --depth-color: rgba(139,92,246,0.2);
    background: linear-gradient(135deg, rgba(139,92,246,0.14) 0%, rgba(139,92,246,0.04) 100%);
    border-color: rgba(139,92,246,0.22);
    box-shadow: 0 10px 36px rgba(139,92,246,0.1);
    text-align: center; width: 220px;
  }
  .iso-card.ok .title { color: var(--client); }

  .badge {
    display: inline-block; font-family: var(--mono);
    font-size: 10px; font-weight: 500; letter-spacing: 1px;
    padding: 3px 10px; border-radius: 6px; margin-top: 8px;
  }
  .badge.size-sm {
    background: rgba(52,211,153,0.1); color: var(--inline);
    border: 1px solid rgba(52,211,153,0.18);
  }
  .badge.size-lg {
    background: rgba(56,189,248,0.1); color: var(--blob);
    border: 1px solid rgba(56,189,248,0.18);
  }

  .legend {
    display: flex; gap: 28px; justify-content: center;
    margin-top: 60px; position: relative; z-index: 1;
  }

  .legend-item {
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; color: var(--text-dim);
  }

  .legend-swatch { width: 10px; height: 10px; border-radius: 3px; }

  .footer {
    text-align: center; margin-top: 40px;
    font-size: 10px; color: var(--text-muted);
    letter-spacing: 2px; position: relative; z-index: 1;
  }

  @media (max-width: 1400px) {
    .flow { transform: scale(0.82); transform-origin: top center; }
  }
  @media (max-width: 1000px) {
    .flow { transform: scale(0.6); transform-origin: top center; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>Confman Distributed Config Service</h1>
  <h2>PUT Write Path</h2>
  <p class="subtitle">End-to-end flow for <code>PUT /api/v1/namespaces/{ns}/config/{key}</code></p>
</div>

<div class="flow">

  <!-- 1. Client -->
  <div class="iso-card client">
    <div class="title">Client</div>
    <div class="desc"><code>PUT</code> request with JSON body containing value + type</div>
  </div>

  <div class="flow-spacer"><div class="vline main"></div></div>

  <!-- 2. Leader Check + Redirect -->
  <div class="leader-row">
    <div class="redirect-arrow">
      <div class="iso-card redirect">
        <div class="title">307 Redirect</div>
        <div class="desc">Forward to leader</div>
      </div>
      <div class="line"></div>
      <div class="dash-text">NOT LEADER</div>
    </div>

    <div class="iso-card decision">
      <div class="title">Is Leader?</div>
      <div class="desc">ConfigController checks Raft role</div>
    </div>
  </div>

  <div class="flow-spacer flow-spacer-lg"><div class="vline main"></div></div>

  <!-- 3. Size Check -->
  <div class="iso-card decision">
    <div class="title">Value ≥ 64 KB?</div>
    <div class="desc">
      <code>UTF8.GetByteCount(value)</code>
      <div style="display:flex; gap:8px; margin-top:10px; justify-content:center;">
        <span class="badge size-sm">&lt; 64KB</span>
        <span class="badge size-lg">≥ 64KB</span>
      </div>
    </div>
  </div>

  <div class="flow-spacer flow-spacer-lg" style="height: 50px;"></div>

  <!-- 4. Fork: Inline vs Blob -->
  <div class="fork-row">

    <!-- Inline Branch -->
    <div class="branch">
      <div class="branch-label inline-label">INLINE PATH</div>
      <div class="branch-spacer"><div class="vline green"></div></div>
      <div class="iso-card inline">
        <div class="step-num">Inline</div>
        <div class="title">SetConfigCommand</div>
        <div class="desc">Value stored directly in the Raft WAL entry. Simple, fast path for small configs.</div>
      </div>
    </div>

    <!-- Blob Branch -->
    <div class="branch">
      <div class="branch-label blob-label">BLOB PATH</div>

      <div class="branch-spacer"><div class="vline blue"></div></div>
      <div class="iso-card blob">
        <div class="step-num">Step 1</div>
        <div class="title">Store Blob Locally</div>
        <div class="desc">Single-pass <code>SHA256</code> + <code>LZ4</code> compress.<br/>80KB buffer → temp file → <code>fsync</code> → atomic rename.</div>
      </div>

      <div class="branch-spacer"><div class="vline blue"></div></div>
      <div class="iso-card blob">
        <div class="step-num">Step 2</div>
        <div class="title">Replicate to Quorum</div>
        <div class="desc">Parallel HTTP PUT to followers.<br/><code>X-Cluster-Token</code> auth.<br/>Wait for majority ack (10s timeout).</div>
      </div>

      <div class="branch-spacer"><div class="vline blue"></div></div>
      <div class="iso-card blob">
        <div class="step-num">Step 3</div>
        <div class="title">Commit Pointer via Raft</div>
        <div class="desc">~100 byte WAL entry. Just the 64-char SHA256 hash.<br/><strong>2500× smaller</strong> than inline for 1MB values.</div>
      </div>
    </div>

  </div>

  <div class="flow-spacer flow-spacer-lg"><div class="vline gold"></div></div>

  <!-- Convergence label -->
  <div class="converge-label">both paths converge</div>

  <!-- 6. Raft Consensus -->
  <div class="iso-card raft">
    <div class="step-num">Convergence</div>
    <div class="title">Raft Consensus</div>
    <div class="desc">Leader appends to WAL → replicated to majority → committed.</div>
  </div>

  <div class="flow-spacer"><div class="vline gold"></div></div>

  <!-- 7. State Machine Apply -->
  <div class="iso-card apply">
    <div class="step-num">Apply</div>
    <div class="title">State Machine</div>
    <div class="desc">LiteDB upsert config entry + create audit event.<br/>Applied on every node in the cluster.</div>
  </div>

  <div class="flow-spacer"><div class="vline main"></div></div>

  <!-- 8. 200 OK -->
  <div class="iso-card ok">
    <div class="title">200 OK</div>
    <div class="desc">Return config entry DTO to client</div>
  </div>

</div>

<div class="legend">
  <div class="legend-item"><div class="legend-swatch" style="background: var(--client);"></div> Client / Response</div>
  <div class="legend-item"><div class="legend-swatch" style="background: var(--decision);"></div> Decision</div>
  <div class="legend-item"><div class="legend-swatch" style="background: var(--inline);"></div> Inline Path</div>
  <div class="legend-item"><div class="legend-swatch" style="background: var(--blob);"></div> Blob Path</div>
  <div class="legend-item"><div class="legend-swatch" style="background: var(--raft);"></div> Raft Consensus</div>
  <div class="legend-item"><div class="legend-swatch" style="background: var(--apply);"></div> State Machine</div>
</div>

<div class="footer">CONFMAN · DISTRIBUTED CONFIGURATION SERVICE · PUT WRITE PATH</div>

</body>
</html>
