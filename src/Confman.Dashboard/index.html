<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONFMAN // Cluster Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0c10;
            --bg-panel: #12151c;
            --bg-elevated: #1a1e28;
            --border: #2a3142;
            --border-subtle: #1e222d;

            --text-primary: #e8eaed;
            --text-secondary: #8b9ab5;
            --text-muted: #5a6578;

            --accent-cyan: #00d4ff;
            --accent-cyan-dim: #00a8cc;
            --accent-green: #00ff88;
            --accent-amber: #ffb800;
            --accent-red: #ff3d5a;

            --glow-cyan: 0 0 20px rgba(0, 212, 255, 0.3);
            --glow-green: 0 0 20px rgba(0, 255, 136, 0.3);
            --glow-amber: 0 0 20px rgba(255, 184, 0, 0.3);
            --glow-red: 0 0 20px rgba(255, 61, 90, 0.3);

            --font-mono: 'IBM Plex Mono', monospace;
            --font-sans: 'Instrument Sans', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Subtle scanline overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* Top bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 32px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-mark {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 14px;
            color: var(--bg-deep);
        }

        .logo-text {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 2px;
            color: var(--text-primary);
        }

        .logo-text span {
            color: var(--text-muted);
            font-weight: 400;
        }

        .top-meta {
            display: flex;
            align-items: center;
            gap: 24px;
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-muted);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meta-label {
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .meta-value {
            color: var(--text-secondary);
        }

        /* Main layout */
        .main-container {
            display: flex;
            height: calc(100vh - 65px);
        }

        .content-area {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
            max-width: 900px;
        }

        .sidebar {
            width: 340px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* Status beacon */
        .status-beacon {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 24px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .beacon-orb {
            position: relative;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beacon-orb::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            animation: beacon-pulse 2s ease-in-out infinite;
        }

        .beacon-orb.healthy {
            background: radial-gradient(circle, var(--accent-green) 0%, rgba(0, 255, 136, 0.2) 70%);
            box-shadow: var(--glow-green);
        }
        .beacon-orb.healthy::before {
            background: var(--accent-green);
            opacity: 0.3;
        }

        .beacon-orb.degraded {
            background: radial-gradient(circle, var(--accent-amber) 0%, rgba(255, 184, 0, 0.2) 70%);
            box-shadow: var(--glow-amber);
        }
        .beacon-orb.degraded::before {
            background: var(--accent-amber);
            opacity: 0.3;
        }

        .beacon-orb.down {
            background: radial-gradient(circle, var(--accent-red) 0%, rgba(255, 61, 90, 0.2) 70%);
            box-shadow: var(--glow-red);
            animation: beacon-alert 1s ease-in-out infinite;
        }
        .beacon-orb.down::before {
            background: var(--accent-red);
            opacity: 0.3;
        }

        @keyframes beacon-pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes beacon-alert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .beacon-icon {
            position: relative;
            z-index: 1;
            font-size: 24px;
        }

        .beacon-info {
            flex: 1;
        }

        .beacon-status {
            font-family: var(--font-mono);
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .beacon-status.healthy { color: var(--accent-green); }
        .beacon-status.degraded { color: var(--accent-amber); }
        .beacon-status.down { color: var(--accent-red); }

        .beacon-detail {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .beacon-detail strong {
            color: var(--accent-cyan);
            font-weight: 500;
        }

        /* Nodes section */
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .section-title {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
        }

        .section-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }

        .nodes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .node-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 18px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s, transform 0.2s;
        }

        .node-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .node-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .node-card.leader::before {
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
        }

        .node-card.follower::before {
            background: var(--accent-cyan);
            opacity: 0.5;
        }

        .node-card.offline::before {
            background: var(--accent-red);
        }

        .node-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .node-identity {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .node-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .node-indicator.ready {
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
            animation: pulse-glow 2s infinite;
        }

        .node-indicator.not-ready {
            background: var(--accent-amber);
            box-shadow: 0 0 8px var(--accent-amber);
        }

        .node-indicator.offline {
            background: var(--accent-red);
            animation: none;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .node-name {
            font-weight: 600;
            font-size: 15px;
        }

        .node-role {
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .node-role.leader {
            background: rgba(0, 255, 136, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .node-role.follower {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent-cyan);
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .node-role.unknown {
            background: rgba(90, 101, 120, 0.2);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .node-url {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .node-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .node-stat {
            background: var(--bg-deep);
            padding: 8px 10px;
            border-radius: 6px;
        }

        .node-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .node-stat-value {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .node-stat-value.status-ready { color: var(--accent-green); }
        .node-stat-value.status-not-ready { color: var(--accent-amber); }
        .node-stat-value.status-offline { color: var(--accent-red); }

        /* Data tables */
        .data-section {
            margin-bottom: 28px;
        }

        .data-table {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .table-header {
            display: grid;
            gap: 16px;
            padding: 12px 18px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .table-header.ns-cols {
            grid-template-columns: 1fr 1.5fr 120px;
        }

        .table-header.config-cols {
            grid-template-columns: 1fr 1fr 100px;
        }

        .table-row {
            display: grid;
            gap: 16px;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.15s;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row.ns-cols {
            grid-template-columns: 1fr 1.5fr 120px;
        }

        .table-row.config-cols {
            grid-template-columns: 1fr 1fr 100px;
        }

        .table-row.clickable {
            cursor: pointer;
        }

        .table-row.clickable:hover {
            background: var(--bg-elevated);
        }

        .table-row.selected {
            background: rgba(0, 212, 255, 0.08);
            border-left: 3px solid var(--accent-cyan);
            padding-left: 15px;
        }

        .cell-primary {
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--accent-cyan);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cell-secondary {
            font-size: 13px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cell-value {
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--accent-green);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cell-meta {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
        }

        .table-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .table-empty-icon {
            font-size: 24px;
            margin-bottom: 8px;
            opacity: 0.4;
        }

        /* Sidebar - Audit Log */
        .sidebar-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-title {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .sidebar-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .sidebar-subtitle .namespace-name {
            font-family: var(--font-mono);
            color: var(--accent-cyan);
            font-weight: 500;
        }

        .audit-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .audit-item {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.15s;
        }

        .audit-item:hover {
            background: var(--bg-elevated);
        }

        .audit-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .audit-action {
            font-family: var(--font-mono);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .audit-action.created { color: var(--accent-green); }
        .audit-action.updated { color: var(--accent-cyan); }
        .audit-action.deleted { color: var(--accent-red); }

        .audit-time {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-muted);
        }

        .audit-actor {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .audit-actor strong {
            color: var(--text-primary);
            font-weight: 500;
        }

        .audit-key {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--accent-amber);
            margin-bottom: 8px;
        }

        .audit-diff {
            background: var(--bg-deep);
            border-radius: 6px;
            padding: 10px 12px;
            font-family: var(--font-mono);
            font-size: 11px;
            line-height: 1.6;
        }

        .diff-old {
            color: var(--accent-red);
            text-decoration: line-through;
            opacity: 0.8;
        }

        .diff-new {
            color: var(--accent-green);
        }

        .audit-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
        }

        .audit-empty-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-elevated);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 20px;
            opacity: 0.5;
        }

        .audit-empty-text {
            font-size: 13px;
            line-height: 1.5;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-deep);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .delay-1 { animation-delay: 0.05s; opacity: 0; }
        .delay-2 { animation-delay: 0.1s; opacity: 0; }
        .delay-3 { animation-delay: 0.15s; opacity: 0; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo">
            <div class="logo-mark">C</div>
            <div class="logo-text">CONFMAN <span>// CLUSTER CONTROL</span></div>
        </div>
        <div class="top-meta">
            <div class="meta-item">
                <span class="meta-label">Last Sync</span>
                <span class="meta-value" id="lastUpdate">—</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="content-area">
            <div class="status-beacon" id="clusterSummary"></div>

            <div class="section-header">
                <span class="section-title">Cluster Nodes</span>
                <span class="section-line"></span>
            </div>
            <div class="nodes-grid" id="nodesRow"></div>

            <div class="data-section">
                <div class="section-header">
                    <span class="section-title">Namespaces</span>
                    <span class="section-line"></span>
                </div>
                <div class="data-table" id="namespaces"></div>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <span class="section-title">Configuration Entries</span>
                    <span class="section-line"></span>
                </div>
                <div class="data-table" id="configs"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Audit Trail</div>
                <div class="sidebar-subtitle" id="auditNamespaceLabel">Select a namespace</div>
            </div>
            <div class="audit-list" id="auditList">
                <div class="audit-empty">
                    <div class="audit-empty-icon">◎</div>
                    <div class="audit-empty-text">
                        Select a namespace to view<br>its change history
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const nodes = [
            { name: 'Node 1', url: 'http://127.0.0.1:6100' },
            { name: 'Node 2', url: 'http://127.0.0.1:6200' },
            { name: 'Node 3', url: 'http://127.0.0.1:6300' }
        ];

        let currentApiUrl = null;
        let selectedNamespace = null;

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function formatDateTime(date) {
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        async function fetchNodeStatus(node) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 2000);
                const response = await fetch(`${node.url}/health/ready`, { signal: controller.signal });
                clearTimeout(timeout);
                const data = await response.json();
                return { ...data, reachable: true };
            } catch (e) {
                return { reachable: false };
            }
        }

        function renderClusterSummary(results) {
            const online = results.filter(r => r.reachable).length;
            const ready = results.filter(r => r.reachable && r.status === 'ready').length;
            const leader = results.find(r => r.reachable && r.cluster?.role === 'leader');
            const hasQuorum = online >= 2;

            let statusClass, statusText, icon;
            if (ready === nodes.length) {
                statusClass = 'healthy';
                statusText = 'CLUSTER ONLINE';
                icon = '✓';
            } else if (hasQuorum && leader) {
                statusClass = 'degraded';
                statusText = 'DEGRADED PERFORMANCE';
                icon = '!';
            } else {
                statusClass = 'down';
                statusText = 'QUORUM LOST';
                icon = '✕';
            }

            const leaderInfo = leader ? leader.cluster.leader : 'None';

            return `
                <div class="beacon-orb ${statusClass}">
                    <span class="beacon-icon">${icon}</span>
                </div>
                <div class="beacon-info">
                    <div class="beacon-status ${statusClass}">${statusText}</div>
                    <div class="beacon-detail">
                        ${online}/${nodes.length} nodes online · Leader: <strong>${leaderInfo}</strong>
                    </div>
                </div>
            `;
        }

        function renderNode(node, data, index) {
            const isOffline = !data.reachable;
            const status = isOffline ? 'offline' : data.status;
            const role = isOffline ? 'unknown' : data.cluster?.role || 'unknown';
            const term = isOffline ? '—' : data.cluster?.term ?? '—';
            const leader = isOffline ? '—' : data.cluster?.leader || '—';
            const leaderKnown = isOffline ? false : data.cluster?.leaderKnown;

            const statusClass = isOffline ? 'offline' : (status === 'ready' ? 'ready' : 'not-ready');
            const cardClass = isOffline ? 'offline' : role;
            const statusText = isOffline ? 'OFFLINE' : (status === 'ready' ? 'READY' : 'NO QUORUM');

            return `
                <div class="node-card ${cardClass}">
                    <div class="node-top">
                        <div class="node-identity">
                            <div class="node-indicator ${statusClass}"></div>
                            <span class="node-name">${node.name}</span>
                        </div>
                        <span class="node-role ${role}">${role}</span>
                    </div>
                    <div class="node-url">${node.url}</div>
                    <div class="node-stats">
                        <div class="node-stat">
                            <div class="node-stat-label">Status</div>
                            <div class="node-stat-value status-${statusClass}">${statusText}</div>
                        </div>
                        <div class="node-stat">
                            <div class="node-stat-label">Epoch</div>
                            <div class="node-stat-value">${term}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function fetchNamespaces(results) {
            const healthyNodes = results
                .map((r, i) => ({ ...r, url: nodes[i].url }))
                .filter(r => r.reachable && r.status === 'ready');

            if (healthyNodes.length === 0) return [];

            const targetNode = healthyNodes.find(n => n.cluster?.role === 'leader') || healthyNodes[0];

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                const response = await fetch(`${targetNode.url}/api/v1/namespaces`, {
                    headers: { 'X-Api-Key': 'confman_dev_abc123' },
                    signal: controller.signal
                });
                clearTimeout(timeout);
                if (!response.ok) return [];
                return await response.json();
            } catch (e) {
                return [];
            }
        }

        function renderNamespaces(namespaces) {
            if (namespaces.length === 0) {
                return `
                    <div class="table-empty">
                        <div class="table-empty-icon">⬡</div>
                        <div>No namespaces created</div>
                    </div>
                `;
            }

            const header = `
                <div class="table-header ns-cols">
                    <span>Path</span>
                    <span>Description</span>
                    <span style="text-align: right">Owner</span>
                </div>
            `;

            const rows = namespaces.map(ns => `
                <div class="table-row ns-cols clickable ${selectedNamespace === ns.path ? 'selected' : ''}"
                     onclick="selectNamespace('${ns.path}')">
                    <div class="cell-primary">${ns.path}</div>
                    <div class="cell-secondary">${ns.description || '—'}</div>
                    <div class="cell-meta">${ns.owner}</div>
                </div>
            `).join('');

            return header + rows;
        }

        async function fetchConfigs(results) {
            const healthyNodes = results
                .map((r, i) => ({ ...r, url: nodes[i].url }))
                .filter(r => r.reachable && r.status === 'ready');

            if (healthyNodes.length === 0) return [];

            const targetNode = healthyNodes.find(n => n.cluster?.role === 'leader') || healthyNodes[0];

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                const response = await fetch(`${targetNode.url}/api/v1/configs`, { signal: controller.signal });
                clearTimeout(timeout);
                if (!response.ok) return [];
                return await response.json();
            } catch (e) {
                return [];
            }
        }

        function renderConfigs(configs) {
            if (configs.length === 0) {
                return `
                    <div class="table-empty">
                        <div class="table-empty-icon">◇</div>
                        <div>No configuration entries</div>
                    </div>
                `;
            }

            const header = `
                <div class="table-header config-cols">
                    <span>Key</span>
                    <span>Value</span>
                    <span style="text-align: right">Namespace</span>
                </div>
            `;

            const rows = configs.map(c => `
                <div class="table-row config-cols">
                    <div class="cell-primary" title="${c.key}">${c.key}</div>
                    <div class="cell-value" title="${c.value}">${c.value}</div>
                    <div class="cell-meta">${c.ns}</div>
                </div>
            `).join('');

            return header + rows;
        }

        async function selectNamespace(path) {
            selectedNamespace = path;

            document.querySelectorAll('.table-row.clickable').forEach(row => {
                const primary = row.querySelector('.cell-primary');
                if (primary?.textContent === path) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });

            document.getElementById('auditNamespaceLabel').innerHTML =
                `<span class="namespace-name">${path}</span>`;
            document.getElementById('auditList').innerHTML = `
                <div class="audit-empty">
                    <div class="audit-empty-icon">⟳</div>
                    <div class="audit-empty-text">Loading...</div>
                </div>
            `;

            try {
                // Fetch audit from ALL nodes and merge (audit events are stored locally per node)
                const allEvents = await fetchAuditFromAllNodes(path);
                document.getElementById('auditList').innerHTML = renderAuditLog(allEvents);
            } catch (e) {
                console.error('Audit fetch error:', e);
                document.getElementById('auditList').innerHTML = `
                    <div class="audit-empty">
                        <div class="audit-empty-icon">!</div>
                        <div class="audit-empty-text">Error loading audit log</div>
                    </div>
                `;
            }
        }

        async function fetchAuditFromAllNodes(namespacePath) {
            const fetchPromises = nodes.map(async (node) => {
                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 2000);

                    const response = await fetch(
                        `${node.url}/api/v1/namespaces/${encodeURIComponent(namespacePath)}/audit`,
                        {
                            headers: { 'X-Api-Key': 'confman_dev_abc123' },
                            signal: controller.signal
                        }
                    );
                    clearTimeout(timeout);

                    if (!response.ok) return [];
                    return await response.json();
                } catch (e) {
                    return [];
                }
            });

            const results = await Promise.all(fetchPromises);

            // Merge and deduplicate by timestamp + action + actor
            const seen = new Set();
            const merged = [];

            for (const events of results) {
                if (!Array.isArray(events)) continue;
                for (const event of events) {
                    const key = `${event.timestamp}-${event.action}-${event.actor}-${event.key || ''}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        merged.push(event);
                    }
                }
            }

            // Sort by timestamp descending (newest first)
            merged.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            return merged;
        }

        function renderAuditLog(events) {
            if (!events || !Array.isArray(events) || events.length === 0) {
                return `
                    <div class="audit-empty">
                        <div class="audit-empty-icon">○</div>
                        <div class="audit-empty-text">No audit events recorded</div>
                    </div>
                `;
            }

            try {
                return events.map(event => {
                    const action = event.action || 'unknown';
                    const actionType = action.split('.')[1] || action;
                    const actionClass = actionType === 'created' ? 'created' :
                                       actionType === 'updated' ? 'updated' :
                                       actionType === 'deleted' ? 'deleted' : '';

                    const time = event.timestamp ? formatDateTime(new Date(event.timestamp)) : '—';
                    const actor = event.actor || 'unknown';
                    const hasKey = event.key != null;

                    let diffHtml = '';
                    if (event.oldValue || event.newValue) {
                        diffHtml = `<div class="audit-diff">`;
                        if (event.oldValue) {
                            diffHtml += `<div class="diff-old">− ${event.oldValue}</div>`;
                        }
                        if (event.newValue) {
                            diffHtml += `<div class="diff-new">+ ${event.newValue}</div>`;
                        }
                        diffHtml += `</div>`;
                    }

                    return `
                        <div class="audit-item">
                            <div class="audit-top">
                                <span class="audit-action ${actionClass}">${action}</span>
                                <span class="audit-time">${time}</span>
                            </div>
                            <div class="audit-actor">by <strong>${actor}</strong></div>
                            ${hasKey ? `<div class="audit-key">Key: ${event.key}</div>` : ''}
                            ${diffHtml}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error rendering audit log:', e);
                return `
                    <div class="audit-empty">
                        <div class="audit-empty-icon">!</div>
                        <div class="audit-empty-text">Error displaying audit log</div>
                    </div>
                `;
            }
        }

        async function refresh() {
            const results = await Promise.all(nodes.map(node => fetchNodeStatus(node)));

            document.getElementById('clusterSummary').innerHTML = renderClusterSummary(results);

            const nodesHtml = nodes.map((node, i) => renderNode(node, results[i], i)).join('');
            document.getElementById('nodesRow').innerHTML = nodesHtml;

            const namespaces = await fetchNamespaces(results);
            document.getElementById('namespaces').innerHTML = renderNamespaces(namespaces);

            const configs = await fetchConfigs(results);
            document.getElementById('configs').innerHTML = renderConfigs(configs);

            const leaderNode = results.find(r => r.reachable && r.cluster?.role === 'leader');
            const anyNode = results.find(r => r.reachable);

            if (leaderNode || anyNode) {
                const targetIdx = leaderNode ? results.indexOf(leaderNode) : results.indexOf(anyNode);
                currentApiUrl = nodes[targetIdx].url;
            } else {
                currentApiUrl = null;
            }

            document.getElementById('lastUpdate').textContent = formatTime(new Date());
        }

        refresh();
        setInterval(refresh, 2000);
    </script>
</body>
</html>
