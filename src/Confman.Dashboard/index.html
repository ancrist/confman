<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>// NEXUS-6 CLUSTER CONTROL //</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-black: #0a0806;
            --bg-panel: #0d0b08;
            --border-amber: #ff9500;
            --border-dim: #4a3800;
            --text-bright: #ffb800;
            --text-amber: #ff9500;
            --text-dim: #8a6a00;
            --text-dark: #3a2a00;
            --glow-amber: 0 0 10px #ff9500, 0 0 20px rgba(255, 149, 0, 0.5);
            --glow-text: 0 0 8px rgba(255, 184, 0, 0.6);
            --green-bright: #39ff14;
            --green-dim: #1a7a0a;
            --red-bright: #ff3131;
            --red-dim: #7a1a1a;
            --font-terminal: 'VT323', monospace;
            --font-mono: 'Share Tech Mono', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: var(--font-terminal);
            background: var(--bg-black);
            color: var(--text-amber);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* CRT screen effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* CRT vignette */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(
                ellipse at center,
                transparent 0%,
                transparent 60%,
                rgba(0, 0, 0, 0.4) 100%
            );
            pointer-events: none;
            z-index: 999;
        }

        /* Screen container with bezel */
        .screen-bezel {
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        /* Top header bar */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border: 1px solid var(--border-dim);
            margin-bottom: 20px;
            background: var(--bg-panel);
        }

        .system-title {
            font-size: 24px;
            letter-spacing: 4px;
            color: var(--text-bright);
            text-shadow: var(--glow-text);
        }

        .system-meta {
            font-size: 18px;
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        .system-meta .value {
            color: var(--text-amber);
        }

        /* Main layout */
        .main-grid {
            display: flex;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            display: flex;
            flex-direction: column;
        }

        /* Panel styling */
        .panel {
            border: 1px solid var(--border-dim);
            background: var(--bg-panel);
            position: relative;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 20px;
            right: 20px;
            height: 1px;
            background: var(--border-amber);
            box-shadow: var(--glow-amber);
        }

        .panel-header {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-dim);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-title {
            font-size: 20px;
            letter-spacing: 3px;
            color: var(--text-bright);
            text-shadow: var(--glow-text);
        }

        .panel-decorator {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border-dim), transparent);
        }

        .panel-content {
            padding: 12px;
        }

        /* Status display */
        .status-panel {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            position: relative;
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            background: currentColor;
            animation: blink-status 1s steps(1) infinite;
        }

        .status-indicator.online {
            color: var(--green-bright);
            box-shadow: 0 0 10px var(--green-bright);
        }

        .status-indicator.degraded {
            color: var(--text-amber);
            box-shadow: 0 0 10px var(--text-amber);
        }

        .status-indicator.offline {
            color: var(--red-bright);
            box-shadow: 0 0 10px var(--red-bright);
        }

        @keyframes blink-status {
            0%, 70% { opacity: 1; }
            71%, 100% { opacity: 0.3; }
        }

        .status-text {
            font-size: 28px;
            letter-spacing: 4px;
            text-shadow: var(--glow-text);
        }

        .status-text.online { color: var(--green-bright); text-shadow: 0 0 10px var(--green-bright); }
        .status-text.degraded { color: var(--text-amber); }
        .status-text.offline { color: var(--red-bright); text-shadow: 0 0 10px var(--red-bright); }

        .status-details {
            font-size: 18px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .status-details .highlight {
            color: var(--text-amber);
        }

        /* Replicant grid */
        .replicant-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .replicant-card {
            border: 1px solid var(--border-dim);
            background: var(--bg-panel);
            padding: 14px;
            position: relative;
        }

        .replicant-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .replicant-card.leader::before {
            background: var(--green-bright);
            box-shadow: 0 0 8px var(--green-bright);
        }

        .replicant-card.follower::before {
            background: var(--text-amber);
            box-shadow: 0 0 8px var(--text-amber);
        }

        .replicant-card.offline::before {
            background: var(--red-bright);
            box-shadow: 0 0 8px var(--red-bright);
        }

        .replicant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-dim);
        }

        .replicant-id {
            font-size: 20px;
            letter-spacing: 2px;
            color: var(--text-bright);
            text-shadow: var(--glow-text);
        }

        .replicant-role {
            font-size: 14px;
            letter-spacing: 1px;
            padding: 2px 8px;
            border: 1px solid currentColor;
        }

        .replicant-role.leader {
            color: var(--green-bright);
        }

        .replicant-role.follower {
            color: var(--text-amber);
        }

        .replicant-role.unknown {
            color: var(--text-dim);
        }

        .replicant-url {
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--text-dim);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .replicant-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-block {
            padding: 8px;
            border: 1px solid var(--border-dim);
            background: var(--bg-black);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-dim);
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 16px;
            color: var(--text-amber);
            letter-spacing: 1px;
        }

        .stat-value.ready { color: var(--green-bright); }
        .stat-value.not-ready { color: var(--text-amber); }
        .stat-value.offline { color: var(--red-bright); }

        /* Data tables */
        .data-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .data-panel .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .table-header {
            display: grid;
            gap: 16px;
            padding: 10px 14px;
            background: var(--bg-black);
            border-bottom: 1px solid var(--border-dim);
            font-size: 14px;
            letter-spacing: 2px;
            color: var(--text-dim);
        }

        .table-header.ns-cols { grid-template-columns: 1fr 1.5fr 100px; }
        .table-header.config-cols { grid-template-columns: 1fr 1fr 100px; }

        .table-row {
            display: grid;
            gap: 16px;
            padding: 10px 14px;
            border-bottom: 1px solid var(--text-dark);
            font-size: 18px;
            transition: background 0.1s;
        }

        .table-row.ns-cols { grid-template-columns: 1fr 1.5fr 100px; }
        .table-row.config-cols { grid-template-columns: 1fr 1fr 100px; }

        .table-row.clickable {
            cursor: pointer;
        }

        .table-row.clickable:hover {
            background: rgba(255, 149, 0, 0.1);
        }

        .table-row.selected {
            background: rgba(255, 149, 0, 0.15);
            border-left: 3px solid var(--text-amber);
            padding-left: 11px;
        }

        .cell-key {
            font-family: var(--font-mono);
            color: var(--text-bright);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-shadow: var(--glow-text);
        }

        .cell-value {
            font-family: var(--font-mono);
            color: var(--green-bright);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-shadow: 0 0 8px rgba(57, 255, 20, 0.4);
        }

        .cell-secondary {
            color: var(--text-dim);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cell-meta {
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--text-dim);
            text-align: right;
        }

        .table-empty {
            padding: 30px;
            text-align: center;
            font-size: 18px;
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        /* Audit sidebar */
        .audit-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .audit-panel .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .audit-namespace {
            font-family: var(--font-mono);
            font-size: 16px;
            color: var(--text-bright);
            text-shadow: var(--glow-text);
        }

        .audit-item {
            padding: 14px;
            border-bottom: 1px solid var(--text-dark);
        }

        .audit-item:hover {
            background: rgba(255, 149, 0, 0.05);
        }

        .audit-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .audit-action {
            font-size: 16px;
            letter-spacing: 1px;
        }

        .audit-action.created { color: var(--green-bright); }
        .audit-action.updated { color: var(--text-amber); }
        .audit-action.deleted { color: var(--red-bright); }

        .audit-time {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-dim);
        }

        .audit-actor {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .audit-actor strong {
            color: var(--text-amber);
        }

        .audit-key {
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--text-bright);
            margin-bottom: 8px;
        }

        .audit-diff {
            background: var(--bg-black);
            border: 1px solid var(--border-dim);
            padding: 8px 10px;
            font-family: var(--font-mono);
            font-size: 14px;
        }

        .diff-old {
            color: var(--red-bright);
            text-decoration: line-through;
        }

        .diff-new {
            color: var(--green-bright);
        }

        .audit-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 30px;
            text-align: center;
            color: var(--text-dim);
        }

        .audit-empty-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--text-dark);
        }

        .audit-empty-text {
            font-size: 16px;
            letter-spacing: 1px;
            line-height: 1.6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-black);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-dim);
            border: 1px solid var(--text-dark);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-dim);
        }

        /* Blinking cursor */
        .cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background: var(--text-amber);
            margin-left: 4px;
            animation: cursor-blink 0.8s steps(1) infinite;
        }

        @keyframes cursor-blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Typing animation for initial load */
        @keyframes type-reveal {
            from { width: 0; }
            to { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="screen-bezel">
        <div class="header-bar">
            <div class="system-title">NEXUS-6 CLUSTER CONTROL</div>
            <div class="system-meta">
                SYNC: <span class="value" id="lastUpdate">--:--:--</span>
            </div>
        </div>

        <div class="main-grid">
            <div class="content-area">
                <div class="panel">
                    <div class="status-panel" id="clusterSummary"></div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">[ REPLICANTS ]</span>
                        <span class="panel-decorator"></span>
                    </div>
                    <div class="panel-content">
                        <div class="replicant-grid" id="nodesRow"></div>
                    </div>
                </div>

                <div class="panel data-panel">
                    <div class="panel-header">
                        <span class="panel-title">[ NAMESPACES ]</span>
                        <span class="panel-decorator"></span>
                    </div>
                    <div class="panel-content" id="namespaces"></div>
                </div>

                <div class="panel data-panel">
                    <div class="panel-header">
                        <span class="panel-title">[ CONFIGURATION ENTRIES ]</span>
                        <span class="panel-decorator"></span>
                    </div>
                    <div class="panel-content" id="configs"></div>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel audit-panel">
                    <div class="panel-header">
                        <span class="panel-title">[ AUDIT TRAIL ]</span>
                        <span class="panel-decorator"></span>
                    </div>
                    <div style="padding: 10px 14px; border-bottom: 1px solid var(--border-dim);">
                        <div class="audit-namespace" id="auditNamespaceLabel">SELECT NAMESPACE</div>
                    </div>
                    <div class="panel-content" id="auditList">
                        <div class="audit-empty">
                            <div class="audit-empty-icon">[?]</div>
                            <div class="audit-empty-text">
                                SELECT A NAMESPACE<br>TO VIEW HISTORY
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const nodes = [
            { name: 'REPLICANT-1', url: 'http://127.0.0.1:6100' },
            { name: 'REPLICANT-2', url: 'http://127.0.0.1:6200' },
            { name: 'REPLICANT-3', url: 'http://127.0.0.1:6300' }
        ];

        let currentApiUrl = null;
        let selectedNamespace = null;

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function formatDateTime(date) {
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).toUpperCase();
        }

        async function fetchNodeStatus(node) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 2000);
                const response = await fetch(`${node.url}/health/ready`, { signal: controller.signal });
                clearTimeout(timeout);
                const data = await response.json();
                return { ...data, reachable: true };
            } catch (e) {
                return { reachable: false };
            }
        }

        function renderClusterSummary(results) {
            const online = results.filter(r => r.reachable).length;
            const ready = results.filter(r => r.reachable && r.status === 'ready').length;
            const leader = results.find(r => r.reachable && r.cluster?.role === 'leader');
            const hasQuorum = online >= 2;

            let statusClass, statusText;
            if (ready === nodes.length) {
                statusClass = 'online';
                statusText = 'INCEPT NOMINAL';
            } else if (hasQuorum && leader) {
                statusClass = 'degraded';
                statusText = 'NEXUS UNSTABLE';
            } else {
                statusClass = 'offline';
                statusText = 'BASELINE FAILED';
            }

            let leaderName = 'NONE';
            if (leader) {
                const leaderUrl = leader.cluster.leader;
                const leaderNode = nodes.find(n => leaderUrl.includes(new URL(n.url).port));
                leaderName = leaderNode ? leaderNode.name : leaderUrl;
            }

            return `
                <div class="status-indicator ${statusClass}"></div>
                <div class="status-text ${statusClass}">${statusText}</div>
                <div class="status-details">
                    ${online}/${nodes.length} REPLICANTS ACTIVE // LEADER: <span class="highlight">${leaderName}</span>
                </div>
            `;
        }

        function renderNode(node, data) {
            const isOffline = !data.reachable;
            const status = isOffline ? 'offline' : data.status;
            const role = isOffline ? 'unknown' : data.cluster?.role || 'unknown';
            const term = isOffline ? '--' : data.cluster?.term ?? '--';

            const statusClass = isOffline ? 'offline' : (status === 'ready' ? 'ready' : 'not-ready');
            const cardClass = isOffline ? 'offline' : role;
            const statusText = isOffline ? 'OFFLINE' : (status === 'ready' ? 'READY' : 'NO QUORUM');

            return `
                <div class="replicant-card ${cardClass}">
                    <div class="replicant-header">
                        <span class="replicant-id">${node.name}</span>
                        <span class="replicant-role ${role}">${role.toUpperCase()}</span>
                    </div>
                    <div class="replicant-url">${node.url}</div>
                    <div class="replicant-stats">
                        <div class="stat-block">
                            <div class="stat-label">STATUS</div>
                            <div class="stat-value ${statusClass}">${statusText}</div>
                        </div>
                        <div class="stat-block">
                            <div class="stat-label">EPOCH</div>
                            <div class="stat-value">${term}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function fetchNamespaces(results) {
            const healthyNodes = results
                .map((r, i) => ({ ...r, url: nodes[i].url }))
                .filter(r => r.reachable && r.status === 'ready');

            if (healthyNodes.length === 0) return [];

            const targetNode = healthyNodes.find(n => n.cluster?.role === 'leader') || healthyNodes[0];

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                const response = await fetch(`${targetNode.url}/api/v1/namespaces`, {
                    headers: { 'X-Api-Key': 'confman_dev_abc123' },
                    signal: controller.signal
                });
                clearTimeout(timeout);
                if (!response.ok) return [];
                return await response.json();
            } catch (e) {
                return [];
            }
        }

        function renderNamespaces(namespaces) {
            if (namespaces.length === 0) {
                return '<div class="table-empty">NO NAMESPACES FOUND</div>';
            }

            const header = `
                <div class="table-header ns-cols">
                    <span>PATH</span>
                    <span>DESCRIPTION</span>
                    <span style="text-align: right">OWNER</span>
                </div>
            `;

            const rows = namespaces.map(ns => `
                <div class="table-row ns-cols clickable ${selectedNamespace === ns.path ? 'selected' : ''}"
                     onclick="selectNamespace('${ns.path}')">
                    <div class="cell-key">${ns.path.toUpperCase()}</div>
                    <div class="cell-secondary">${(ns.description || '--').toUpperCase()}</div>
                    <div class="cell-meta">${ns.owner.toUpperCase()}</div>
                </div>
            `).join('');

            return header + rows;
        }

        async function fetchConfigs(results) {
            const healthyNodes = results
                .map((r, i) => ({ ...r, url: nodes[i].url }))
                .filter(r => r.reachable && r.status === 'ready');

            if (healthyNodes.length === 0) return [];

            const targetNode = healthyNodes.find(n => n.cluster?.role === 'leader') || healthyNodes[0];

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                const response = await fetch(`${targetNode.url}/api/v1/configs`, { signal: controller.signal });
                clearTimeout(timeout);
                if (!response.ok) return [];
                return await response.json();
            } catch (e) {
                return [];
            }
        }

        function renderConfigs(configs) {
            if (configs.length === 0) {
                return '<div class="table-empty">NO CONFIGURATION ENTRIES</div>';
            }

            const header = `
                <div class="table-header config-cols">
                    <span>KEY</span>
                    <span>VALUE</span>
                    <span style="text-align: right">NAMESPACE</span>
                </div>
            `;

            const rows = configs.map(c => `
                <div class="table-row config-cols">
                    <div class="cell-key" title="${c.key}">${c.key.toUpperCase()}</div>
                    <div class="cell-value" title="${c.value}">${c.value}</div>
                    <div class="cell-meta">${c.ns.toUpperCase()}</div>
                </div>
            `).join('');

            return header + rows;
        }

        async function selectNamespace(path) {
            selectedNamespace = path;

            document.querySelectorAll('.table-row.clickable').forEach(row => {
                const key = row.querySelector('.cell-key');
                if (key?.textContent === path.toUpperCase()) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });

            document.getElementById('auditNamespaceLabel').textContent = path.toUpperCase();
            document.getElementById('auditList').innerHTML = `
                <div class="audit-empty">
                    <div class="audit-empty-icon">[...]</div>
                    <div class="audit-empty-text">LOADING DATA</div>
                </div>
            `;

            try {
                const allEvents = await fetchAuditFromAllNodes(path);
                document.getElementById('auditList').innerHTML = renderAuditLog(allEvents);
            } catch (e) {
                console.error('Audit fetch error:', e);
                document.getElementById('auditList').innerHTML = `
                    <div class="audit-empty">
                        <div class="audit-empty-icon">[!]</div>
                        <div class="audit-empty-text">ERROR LOADING AUDIT</div>
                    </div>
                `;
            }
        }

        async function fetchAuditFromAllNodes(namespacePath) {
            const fetchPromises = nodes.map(async (node) => {
                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 2000);

                    const response = await fetch(
                        `${node.url}/api/v1/namespaces/${encodeURIComponent(namespacePath)}/audit`,
                        {
                            headers: { 'X-Api-Key': 'confman_dev_abc123' },
                            signal: controller.signal
                        }
                    );
                    clearTimeout(timeout);

                    if (!response.ok) return [];
                    return await response.json();
                } catch (e) {
                    return [];
                }
            });

            const results = await Promise.all(fetchPromises);

            const seen = new Set();
            const merged = [];

            for (const events of results) {
                if (!Array.isArray(events)) continue;
                for (const event of events) {
                    const key = `${event.timestamp}-${event.action}-${event.actor}-${event.key || ''}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        merged.push(event);
                    }
                }
            }

            merged.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            return merged;
        }

        function renderAuditLog(events) {
            if (!events || !Array.isArray(events) || events.length === 0) {
                return `
                    <div class="audit-empty">
                        <div class="audit-empty-icon">[0]</div>
                        <div class="audit-empty-text">NO AUDIT EVENTS</div>
                    </div>
                `;
            }

            try {
                return events.map(event => {
                    const action = event.action || 'UNKNOWN';
                    const actionType = action.split('.')[1] || action;
                    const actionClass = actionType === 'created' ? 'created' :
                                       actionType === 'updated' ? 'updated' :
                                       actionType === 'deleted' ? 'deleted' : '';

                    const time = event.timestamp ? formatDateTime(new Date(event.timestamp)) : '--';
                    const actor = event.actor || 'UNKNOWN';
                    const hasKey = event.key != null;

                    let diffHtml = '';
                    if (event.oldValue || event.newValue) {
                        diffHtml = `<div class="audit-diff">`;
                        if (event.oldValue) {
                            diffHtml += `<div class="diff-old">- ${event.oldValue}</div>`;
                        }
                        if (event.newValue) {
                            diffHtml += `<div class="diff-new">+ ${event.newValue}</div>`;
                        }
                        diffHtml += `</div>`;
                    }

                    return `
                        <div class="audit-item">
                            <div class="audit-top">
                                <span class="audit-action ${actionClass}">${action.toUpperCase()}</span>
                                <span class="audit-time">${time}</span>
                            </div>
                            <div class="audit-actor">BY <strong>${actor.toUpperCase()}</strong></div>
                            ${hasKey ? `<div class="audit-key">KEY: ${event.key.toUpperCase()}</div>` : ''}
                            ${diffHtml}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error rendering audit log:', e);
                return `
                    <div class="audit-empty">
                        <div class="audit-empty-icon">[!]</div>
                        <div class="audit-empty-text">RENDER ERROR</div>
                    </div>
                `;
            }
        }

        async function refresh() {
            const results = await Promise.all(nodes.map(node => fetchNodeStatus(node)));

            document.getElementById('clusterSummary').innerHTML = renderClusterSummary(results);

            const nodesHtml = nodes.map((node, i) => renderNode(node, results[i])).join('');
            document.getElementById('nodesRow').innerHTML = nodesHtml;

            const namespaces = await fetchNamespaces(results);
            document.getElementById('namespaces').innerHTML = renderNamespaces(namespaces);

            const configs = await fetchConfigs(results);
            document.getElementById('configs').innerHTML = renderConfigs(configs);

            const leaderNode = results.find(r => r.reachable && r.cluster?.role === 'leader');
            const anyNode = results.find(r => r.reachable);

            if (leaderNode || anyNode) {
                const targetIdx = leaderNode ? results.indexOf(leaderNode) : results.indexOf(anyNode);
                currentApiUrl = nodes[targetIdx].url;
            } else {
                currentApiUrl = null;
            }

            document.getElementById('lastUpdate').textContent = formatTime(new Date());
        }

        refresh();
        setInterval(refresh, 2000);
    </script>
</body>
</html>
